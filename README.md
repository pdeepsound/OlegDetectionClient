# Oleg Detection Python API 

## Введение

**Oleg Detection** — система для детектирования голоса Ассистента Олега на аудиозаписях. Точность распознавания и отличия голоса Олега от голоса человека (или другого автоответчика) составляет **более 95%** (по метрике Balanced Accuracy) после первой секунды сказанной фразы и **более 99%** после произношения полной фразы вне зависимости от текста сказанной фразы (тесты проводились на аудиозаписях с частотой дискретизации 8000 Гц).

Данный репозиторий содержит клиентскую часть системы **Oleg Detection** для языка Python и примеры использования различных POST запросов для общения с сервером: взаимодействия с учетной записью и распознавание аудиозаписей.

На данный момент реализовано два режима распознавания:
- **Long Mode** используется для распознавания длинных аудиозаписей (от 5 секунд до 60 минут) и возвращает информацию о каждой фразе с речью (начало, конец, длительность фразы и результаты распознавания);
- **Short Mode** используется для распознавания коротких аудиозаписей (до 15 секунд) и возвращает только результат распознавания (без разметки фраз).

Поддерживаются аудиозаписи в формате .wav с битовой глубиной 16 и с любой частотой дискретизации.

## Установка
После клонирования проекта:
```bash
cd OlegDetectionClient
pip install .
```

## Примеры использования Oleg Detection API
Импорт необходимых пакетов
```python
from od_client import ODAuthentication
from od_client import ODRecognizer
from od_client import load_wav
```

- **ODAuthentication** используется в учетную запись для входа по логину и паролю, генерации новых токенов (которые далее используются для распознавания), и получения информации об используемых токенах;

- **ODRecognizer** используется для распознавания аудио с помощью токенов.


### Взаимодействия с учетной записью
#### Вход в систему
Для аутентификации необходимо ввести собственный логин и пароль:
```python
USERNAME = 'username'
PASSWORD = 'password'

authenticator = ODAuthentication(USERNAME, PASSWORD)
```
#### Получение нового API-токена
Метод **new_token()** используется для генерации нового API-токена, который действует один месяц (максимальное количество действующих токенов для одного пользователя — 10):
```python
authenticator.new_token()
```
Пример ответа:
```
{'token': '2434c5aa6c414f272b687664a589cea21793069de10f2805b9870c675492121a', 'expires': '2022-07-22'}
```

#### Получение информации о действующих токенах
Получение информации о действующих токенах, прикрепленных к пользователю с помощью метода **all_tokens()**:
```python
authenticator.all_tokens()
```
Пример ответа:
```
[{'token': '15bdd490a5bf59aacb972c7583cb545e95c882d304f0a5b093863cd7fde100a5', 'expires': '2022-07-22'},
 {'token': '2434c5aa6c414f272b687664a589cea21793069de10f2805b9870c675492121a', 'expires': '2022-07-22'}]
```

#### Получение информации о количестве распознанных секунд
Получение информации о количестве распознанных секунд пользователем для каждого режима (Long Mode и Short Mode) за весь период с помощью **recognized_seconds_by_user(date='all')**:
```python
authenticator.recognized_seconds_by_user(date='all')
```
Пример ответа:
```
{'short_mode': 21.52, 'long_mode': 67.17, 'all': 88.69}
```

Получение информации о количестве распознанных секунд пользователем с начала месяца с помощью **recognized_seconds_by_user(date='month')**:
```python
authenticator.recognized_seconds_by_user(date='month')
```

### Распознавание аудиозаписей с помощью API-токена
Получение доступа к системе распознавания с помощью API-токена TOKEN, который сгенерирован ранее с помощью метода **new_token()**:
```python
API_TOKEN = 'TOKEN'

recognizer = ODRecognizer(API_TOKEN)
```

#### Получение информации об API-токене
Метод **token_information()** возвращает информацию о владельце токена и период действия
```python
recognizer.token_information()
```
Пример ответа:
```
{'owner': 'username', 'expires': '2022-07-22'}
```

#### Получение информации о количестве распознанных секунд для конкретного API-токена
Получение информации о количестве распознанных секунд с помощью токена
```python
recognizer.recognized_seconds_by_token()
```
Пример ответа:
```
{'short_mode': 21.52, 'long_mode': 67.17, 'all': 88.69}
```

#### Примеры распознавания

Для загрузки байтов из аудиофайла и другой необходимой информации используется предложенный метод **load_wav(path_to_file, channel)**, где:
- **path_to_file** — путь до аудиофайла;
- **max_duration** — количество секунд от начала аудиофайла, которое необходимо загрузить (если max_duration = - 1, то загрузится полный аудиофайл);
- **channel** — номер канала, на котором возможно появление Ассистента Олега (для исходящих звонков со стороны колл-центров чаще всего этот канал под индексом 0). Сервер принимает исключительно одноканальные аудио, поэтому необходимо выбрать один из двух в случае двухканальной записи.

Данный метод возвращает последовательность байтов (**audio_bytes**), частоту дискретизации (**sr**), глубину кодирования (**dtype**) и длительность в секундах (**duration**)

```python
audio_bytes, sr, dtype, duration = load_wav(path/to/audio/file, max_duration=-1, channel=0)
```

Для распознавания используется метод **recognize(audio_bytes, sr, dtype, mode)**, где:
- **audio_bytes** — байты, извлеченные из аудиофайла;
- **sr** — частота дискретизации;
- **dtype** — глубина кодирования (на данный момент поддерживается только int16);
- **mode** — режим распознавания ('short' для Short Mode и 'long' для Long Mode).

Ответы:
- для **mode = 'short'** метод возвращает строку **oleg** если запись задержит речь Ассистента Олега, **not_oleg** если запись содержит речь человека или другого автоответчика, либо **None** если запись не содержит речь;

- для **mode = 'long'** метод возвращает **таблицу (объект pandas.DataFrame)** если запись задержит речь и **None** иначе. Таблица содержит начало фраз с речью в секундах **start**, конец **end** и длительность **duration**, а также результаты распознавания **results** (строки 'oleg' или 'not_oleg') для каждой фразы и **confidence** (вероятность, что речь принадлежит Ассистенту Олегу).

```python
results = recognizer.recognize(audio_bytes=audio_bytes, sr=sr, dtype=dtype, mode='short')
```

Больше примеров и более подробное описание представлено в файле **tutorial.ipynb** в формате Jupyter Notebook.


